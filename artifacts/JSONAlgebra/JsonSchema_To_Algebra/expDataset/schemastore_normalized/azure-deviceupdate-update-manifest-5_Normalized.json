{
  "$id": "https://json.schemastore.org/azure-deviceupdate-update-manifest-5.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "definitions": {
    "miniUpdateManifest": {
      "type": "object",
      "title": "Mini update manifest",
      "description": "Manifest containing metadata of the detached, downloadable, complete update manifest.",
      "properties": {
        "detachedManifestFileId": {
          "$ref": "#/definitions/fileId"
        },
        "files": {
          "type": "object",
          "title": "Update manifest file",
          "description": "Map of '#/definitions/fileId' to file metadata.",
          "additionalProperties": {
            "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_file"
          },
          "minProperties": 1,
          "maxProperties": 1
        }
      },
      "required": [
        "detachedManifestFileId",
        "files"
      ]
    },
    "fullUpdateManifest": {
      "type": "object",
      "title": "Complete update manifest.",
      "description": "Full update manifest containing metadata of the update being deployed.",
      "properties": {
        "compatibility": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_compatibility"
        },
        "instructions": {
          "type": "object",
          "title": "Installation instructions",
          "properties": {
            "steps": {
              "type": "array",
              "title": "Installation steps",
              "items": {
                "anyOf": [
                  {
                    "$ref": "#/definitions/inlineStep"
                  },
                  {
                    "$ref": "#/definitions/referenceStep"
                  }
                ]
              },
              "minItems": 1,
              "maxItems": 10
            }
          },
          "required": [
            "steps"
          ]
        },
        "files": {
          "type": "object",
          "title": "Update files",
          "description": "Map of '#/definitions/fileId' to file metadata.",
          "additionalProperties": {
            "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_file"
          },
          "minProperties": 1,
          "maxProperties": 20
        },
        "createdDateTime": {
          "type": "string",
          "title": "Created date & time",
          "description": "Date & time update was created in ISO 8601 format.",
          "examples": [
            "2020-10-02T22:18:04.9446744Z"
          ]
        }
      },
      "required": [
        "compatibility",
        "instructions",
        "files",
        "createdDateTime"
      ]
    },
    "fileId": {
      "type": "string",
      "title": "Update file id",
      "description": "Server generated file identifier to be used for retrieving file metadata and download URL.",
      "minLength": 1
    },
    "inlineStep": {
      "type": "object",
      "title": "Inline installation step",
      "description": "Installation instruction step that performs code execution.",
      "properties": {
        "type": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_inlineStepType"
        },
        "handler": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_inlineStepHandler"
        },
        "files": {
          "type": "array",
          "title": "Step update files",
          "description": "'fileId' of update files that agent will pass to handler.",
          "items": {
            "$ref": "#/definitions/fileId"
          },
          "minItems": 1,
          "maxItems": 10
        },
        "handlerProperties": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_inlineStepHandlerProperties"
        }
      },
      "additionalProperties": false,
      "required": [
        "handler",
        "files"
      ]
    },
    "referenceStep": {
      "type": "object",
      "title": "Reference installation step",
      "description": "Installation instruction step that installs another update.",
      "properties": {
        "type": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_referenceStepType"
        },
        "detachedManifestFileId": {
          "$ref": "#/definitions/fileId"
        }
      },
      "additionalProperties": false,
      "required": [
        "type",
        "detachedManifestFileId"
      ]
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_file": {
      "type": "object",
      "title": "Update file",
      "description": "Update payload file, e.g. binary, firmware, script, etc. Must be unique within update.",
      "allOf": [
        {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_baseFile"
        }
      ],
      "properties": {
        "relatedFiles": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_baseFile"
          },
          "minItems": 0,
          "maxItems": 4,
          "description": "Optional related files metadata used together with DownloadHandler metadata to download payload file."
        },
        "downloadHandler": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_fileDownloadHandler",
          "description": "Optional download handler for utilizing related files to download payload file."
        }
      }
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_baseFile": {
      "type": "object",
      "title": "Basic update file information",
      "description": "Update payload file, e.g. binary, firmware, script, etc. Must be unique within update.",
      "properties": {
        "filename": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_filename"
        },
        "sizeInBytes": {
          "type": "number",
          "title": "File size",
          "description": "File size in number of bytes.",
          "minimum": 1,
          "maximum": 2147483648
        },
        "hashes": {
          "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_fileHashes"
        },
        "properties": {
          "type": "object",
          "additionalProperties": true,
          "description": "Optional file properties (not consumed by service but pass-through to device)."
        }
      },
      "required": [
        "filename",
        "sizeInBytes",
        "hashes"
      ]
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_filename": {
      "type": "string",
      "title": "Update file name",
      "description": "Update payload file name.",
      "minLength": 1,
      "maxLength": 255
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_fileHashes": {
      "type": "object",
      "title": "File hashes",
      "description": "Base64-encoded file hashes with algorithm name as key. At least SHA-256 algorithm must be specified, and additional algorithm may be specified if supported by agent.",
      "properties": {
        "sha256": {
          "type": "string",
          "title": "SHA-256 hash value",
          "description": "Base64-encoded file hash value using SHA-256 algorithm."
        }
      },
      "additionalProperties": {
        "type": "string",
        "propertyNames": {
          "maxLength": 10
        }
      },
      "maxProperties": 2,
      "required": [
        "sha256"
      ]
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_fileDownloadHandler": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Download handler identifier.",
          "pattern": "^\\S+/\\S+:\\d{1,5}$",
          "minLength": 5,
          "maxLength": 32,
          "examples": [
            "microsoft/delta:1"
          ]
        }
      },
      "required": [
        "id"
      ],
      "description": "Download handler for utilizing related files to download payload file."
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_compatibility": {
      "type": "array",
      "title": "Update compatibility",
      "description": "List of device property sets this update is compatible with.",
      "items": {
        "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_compatibilityInfo"
      },
      "minItems": 1,
      "maxItems": 10
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_compatibilityInfo": {
      "type": "object",
      "title": "Update compatibility info",
      "description": "Properties of a device this update is compatible with.",
      "additionalProperties": {
        "type": "string",
        "minLength": 1,
        "maxLength": 64,
        "propertyNames": {
          "minLength": 1,
          "maxLength": 32
        }
      },
      "minProperties": 1,
      "maxProperties": 5
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_inlineStepType": {
      "type": "string",
      "title": "'Inline' step type",
      "description": "Instruction step type that performs code execution.",
      "const": "inline"
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_inlineStepHandler": {
      "type": "string",
      "title": "Step handler",
      "description": "Identity of handler on device that can execute this step.",
      "pattern": "^\\S+/\\S+:\\d{1,5}$",
      "minLength": 5,
      "maxLength": 32,
      "examples": [
        "microsoft/script:1",
        "microsoft/swupdate:1",
        "microsoft/apt:1"
      ]
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_inlineStepHandlerProperties": {
      "type": "object",
      "title": "Handler properties",
      "description": "JSON object that agent will pass to handler as arguments.",
      "additionalProperties": true
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_referenceStepType": {
      "type": "string",
      "title": "'Reference' step type",
      "description": "Instruction step type that installs another update.",
      "const": "reference"
    },
    "azure-deviceupdate-manifest-defs-5_0_json_defs_updateId": {
      "type": "object",
      "title": "Update identity",
      "description": "Unique update identifier.",
      "properties": {
        "provider": {
          "type": "string",
          "title": "Update provider",
          "description": "Entity who is creating or directly responsible for the update. It can be a company name.",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[a-zA-Z0-9.-]+$"
        },
        "name": {
          "type": "string",
          "title": "Update name",
          "description": "Identifier for a class of update. It can be a device class or model name.",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[a-zA-Z0-9.-]+$"
        },
        "version": {
          "type": "string",
          "title": "Update version",
          "description": "Two to four part dot separated numerical version numbers. Each part must be a number between 0 and 2147483647 and leading zeroes will be dropped.",
          "pattern": "^\\d+(?:\\.\\d+)+$",
          "examples": [
            "1.0",
            "2021.11.8"
          ]
        }
      },
      "additionalProperties": false,
      "required": [
        "provider",
        "name",
        "version"
      ]
    }
  },
  "description": "JSON schema of update manifest sent by Device Update for IoT Hub to device agent during deployment.",
  "examples": [
    {
      "manifestVersion": "4",
      "updateId": {
        "provider": "Microsoft",
        "name": "Toaster",
        "version": "1.0"
      },
      "compatibility": [
        {
          "deviceManufacturer": "Microsoft",
          "deviceModel": "Toaster"
        }
      ],
      "instructions": {
        "steps": [
          {
            "handler": "microsoft/script:1",
            "handlerProperties": {
              "arguments": "--pre-install"
            },
            "files": [
              "fileId0"
            ]
          },
          {
            "type": "reference",
            "detachedManifestFileId": "fileId1"
          }
        ]
      },
      "files": {
        "fileId0": {
          "filename": "configure.sh",
          "sizeInBytes": 718,
          "hashes": {
            "sha256": "mcB5SexMU4JOOzqmlJqKbue9qMskWY3EI/iVjJxCtAs="
          },
          "relatedFiles": [
            {
              "filename": "in1_in2_deltaupdate.dat",
              "sizeInBytes": 102910752,
              "hashes": {
                "sha256": "2MIldV8LkdKenjJasgTHuYi+apgtNQ9FeL2xsV3ikHY="
              },
              "properties": {
                "microsoft.sourceFileHashAlgorithm": "sha256",
                "microsoft.sourceFileHash": "YmFYwnEUddq2nZsBAn5v7gCRKdHx+TUntMz5tLwU+24="
              }
            }
          ],
          "downloadHandler": {}
        },
        "fileId1": {
          "filename": "microsoft.sensor.1.0.updatemanifest.json",
          "sizeInBytes": 2048,
          "hashes": {
            "sha256": "789s9PDfX4uA9wFUubyC30BWkLFbgmpkpmz1fEdqo2U="
          }
        }
      },
      "createdDateTime": "2021-09-28T18:32:01.8404544Z"
    }
  ],
  "oneOf": [
    {
      "$ref": "#/definitions/miniUpdateManifest"
    },
    {
      "$ref": "#/definitions/fullUpdateManifest"
    }
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON schema reference"
    },
    "updateId": {
      "$ref": "#/definitions/azure-deviceupdate-manifest-defs-5_0_json_defs_updateId"
    },
    "manifestVersion": {
      "type": "string",
      "title": "Update manifest schema version",
      "const": "4"
    }
  },
  "required": [
    "updateId",
    "manifestVersion"
  ],
  "title": "JSON Schema for Azure Device Update for IoT Hub 'Update Manifest' version 4.0",
  "type": "object"
}